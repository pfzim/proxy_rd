[Options]
bindport="localhost:3128"
redir_header="// script only for me mcep.ru - file POST method with crypt - beta\r\n\r\nimport __cdecl dup(1);\r\nimport __cdecl add(2);\r\nimport __cdecl free(1);\r\nimport __cdecl encode(1);\r\nimport __cdecl encoden(2);\r\nimport __cdecl msg(2);\r\nimport __cdecl yes(2);\r\nimport __cdecl isempty(1);\r\nimport __cdecl isset(1);\r\nimport __cdecl strstr(2);\r\nimport __cdecl strstri(2);\r\nimport __cdecl dupn(1);\r\nimport __cdecl crypt(3);\r\n\r\nimport __cdecl strcmp(2);\r\nimport __cdecl stricmp(2);\r\nimport __cdecl htmlencode(1);\r\nimport __cdecl atoi(1);\r\nimport __cdecl zalloc(1);\r\nimport __cdecl zrealloc(2);\r\nimport __cdecl zfree(1);\r\nimport __cdecl pcre_match_all(7);\r\nimport __cdecl pcre_match_free(1);\r\nimport __cdecl strlen(1);\r\n\r\nfunction main()\r\n{\r\n\t// initialise global variables here\r\n\t//msg(\"proxy_rd\",\"Hello, world!\");\r\n}\r\n\r\nfunction proxy_rd(\r\n\tunsigned long *header_len, char **post_data, unsigned long *post_data_len, char **footer, unsigned long *footer_len,\r\n\tunsigned long *options, char **rdhost, char **rdport,\r\n\tchar *method, char *protocol, char *uri_full, char *uri_relative, char *uri_full_encoded,\r\n\tchar *host, char *build, char *h_host_port, char *h_unknown, char *h_cookie, char *h_accept,\r\n\tchar *h_accept_lang, char *h_accept_charset, char *h_if_mod_since, char *h_if_none_match,\r\n\tchar *h_referer, char *h_user_agent, char *h_proxy_connection, char *h_keep_alive,\r\n\tchar *h_authorization, char *h_cache_control, char *h_pragma, char *h_range, char *h_content_type,\r\n\tchar *h_content_length, char *port, char *query, char *scheme, char *authority, char *path, char *fragment\r\n)\r\n{\r\n\tchar *header;\r\n\tchar *header2;\r\n\tchar *temp;\r\n\tchar *temp2;\r\n\tunsigned long crypt_offset;\r\n\tunsigned long crypt_size;\r\n\r\n\theader = NULL;\r\n\theader2 = NULL;\r\n\r\n\tif(isempty(host))\r\n\t{\r\n\t\tmsg(\"proxy_rd debug msg\", \"strange: host not defined!\");\r\n\t}\r\n\r\n\tif(*options & 0x04)\r\n\t{\r\n\t\t// connect method no need header - exit\r\n\t\treturn NULL;\r\n\t}\r\n\r\n\t// connect to host trough proxy script\r\n\t//*rdhost = dup(\"www.pfzim.ru\");\r\n\t*rdhost = dup(\"intweb\");\r\n\t//*rdhost = dup(\"localhost\");\r\n\t//*rdport = dup(\"3129\");\r\n\r\n\t//add(&header2, method);\r\n\t//add(&header2, \" http://www.pfzim.ru/funcs/redir_nx.php\?id=\");\r\n\t//add(&header2, \" http://localhost/lab/redir_nx.php\?id=\");\r\n\t//add(&header2, \" http://intweb/bitrix/tools/redir_nx.php\?id=\");\r\n\tadd(&header2, \"POST http://intweb/bitrix/tools/redir_nx.php\?id=aHR0cDovL3d3dy5leGFtcGxlLmNvbS8%3D&px=\");\r\n\ttemp = dup(host);\r\n\tadd(&temp, \":\");\r\n\tadd(&temp, isempty(port)\?\"80\":port);\r\n\ttemp2 = encode(temp);\r\n\tadd(&header2, temp2);\r\n\tfree(temp);\r\n\tfree(temp2);\r\n\tadd(&header2, \"&pm=on&log=off&ci=on&co=on&filelog=off HTTP/1.0\\r\\n\");\r\n\r\n\t//add(&header2, \"Host: www.pfzim.ru\\r\\n\");\r\n\tadd(&header2, \"Host: intweb\\r\\n\");\r\n\t//add(&header2, \"Host: localhost\\r\\n\");\r\n\t//add(&header2, \"Proxy-Connection: close\\r\\n\");\r\n\tadd(&header2, \"Connection: close\\r\\n\");\r\n\tadd(&header2, \"Content-Type: multipart/form-data; boundary=-----------------------------e5ab6264db2c4f4\\r\\n\");\r\n\r\n\tadd(&header, \"-------------------------------e5ab6264db2c4f4\\r\\nContent-Disposition: form-data; name=\\\"request\\\"; filename=\\\"request.txt\\\"\\r\\nContent-Type: application/octet-stream\\r\\n\\r\\n\");\r\n\tadd(footer, \"\\r\\n-------------------------------e5ab6264db2c4f4--\\r\\n\");\r\n\t\r\n\tcrypt_offset = strlen(header);\r\n\r\n\t//add(&header, temp2);\r\n\t\r\n\tadd(&header, method);\r\n\tadd(&header, \" \");\r\n\tadd(&header, uri_relative);\r\n\tadd(&header, \" \");\r\n\tadd(&header, protocol);\r\n\tadd(&header, \"\\r\\n\");\r\n\r\n\tadd(&header, \"Connection: close\\r\\n\");\r\n\r\n\tif(!isempty(h_host_port))\r\n\t{\r\n\t\tadd(&header, \"Host: \");\r\n\t\tadd(&header, h_host_port);\r\n\t\tadd(&header, \"\\r\\n\");\r\n\t}\r\n\r\n\tif(!isempty(h_cache_control))\r\n\t{\r\n\t\tadd(&header, \"Cache-Control: \");\r\n\t\tadd(&header, h_cache_control);\r\n\t\tadd(&header, \"\\r\\n\");\r\n\t}\r\n\r\n\tif(!isempty(h_pragma))\r\n\t{\r\n\t\tadd(&header, \"Pragma: \");\r\n\t\tadd(&header, h_pragma);\r\n\t\tadd(&header, \"\\r\\n\");\r\n\t}\r\n\r\n\tif(!isempty(h_accept))\r\n\t{\r\n\t\tadd(&header, \"Accept: \");\r\n\t\tadd(&header, h_accept);\r\n\t\tadd(&header, \"\\r\\n\");\r\n\t}\r\n\r\n\tif(!isempty(h_accept_lang))\r\n\t{\r\n\t\tadd(&header, \"Accept-Language: \");\r\n\t\tadd(&header, h_accept_lang);\r\n\t\tadd(&header, \"\\r\\n\");\r\n\t}\r\n\r\n\tif(!isempty(h_accept_charset))\r\n\t{\r\n\t\tadd(&header, \"Accept-Charset: \");\r\n\t\tadd(&header, h_accept_charset);\r\n\t\tadd(&header, \"\\r\\n\");\r\n\t}\r\n\r\n\tif(!isempty(h_if_mod_since))\r\n\t{\r\n\t\tadd(&header, \"If-Modified-Since: \");\r\n\t\tadd(&header, h_if_mod_since);\r\n\t\tadd(&header, \"\\r\\n\");\r\n\t}\r\n\r\n\tif(!isempty(h_if_none_match))\r\n\t{\r\n\t\tadd(&header, \"If-None-Match: \");\r\n\t\tadd(&header, h_if_none_match);\r\n\t\tadd(&header, \"\\r\\n\");\r\n\t}\r\n\r\n\tif(!isempty(h_referer))\r\n\t{\r\n\t\tadd(&header, \"Referer: \");\r\n\t\tadd(&header, h_referer);\r\n\t\tadd(&header, \"\\r\\n\");\r\n\t}\r\n\r\n\tif(!isempty(h_user_agent))\r\n\t{\r\n\t\tadd(&header, \"User-Agent: \");\r\n\t\tadd(&header, h_user_agent);\r\n\t\tadd(&header, \"\\r\\n\");\r\n\t}\r\n\r\n\tif(!isempty(h_authorization))\r\n\t{\r\n\t\tadd(&header, \"Authorization: \");\r\n\t\tadd(&header, h_authorization);\r\n\t\tadd(&header, \"\\r\\n\");\r\n\t}\r\n\r\n\tif(!isempty(h_range))\r\n\t{\r\n\t\tadd(&header, \"Range: \");\r\n\t\tadd(&header, h_range);\r\n\t\tadd(&header, \"\\r\\n\");\r\n\t}\r\n\r\n\tif(!isempty(h_content_type))\r\n\t{\r\n\t\tadd(&header, \"Content-Type: \");\r\n\t\tadd(&header, h_content_type);\r\n\t\tadd(&header, \"\\r\\n\");\r\n\t}\r\n\r\n\tif(!isempty(h_content_length))\r\n\t{\r\n\t\tadd(&header, \"Content-Length: \");\r\n\t\tadd(&header, h_content_length);\r\n\t\tadd(&header, \"\\r\\n\");\r\n\t}\r\n\r\n\tif(!isempty(h_cookie))\r\n\t{\r\n\t\tadd(&header, \"Cookie: \");\r\n\t\tadd(&header, h_cookie);\r\n\t\tadd(&header, \"\\r\\n\");\r\n\t}\r\n\r\n\tadd(&header, h_unknown);\r\n\r\n\tadd(&header, \"\\r\\n\");\r\n\r\n\t*header_len = strlen(header);\r\n\t*footer_len = strlen(*footer);\r\n\r\n\tadd(&header2, \"Content-Length: \");\r\n\ttemp = dupn(*post_data_len + *header_len + *footer_len);\r\n\tadd(&header2, temp);\r\n\tfree(temp);\r\n\tadd(&header2, \"\\r\\n\\r\\n\");\r\n\r\n\tcrypt_size = *header_len - crypt_offset;\r\n\tcrypt_offset += strlen(header2);\r\n\t*header_len += strlen(header2);\r\n\t\r\n\tadd(&header2, header);\r\n\tfree(header);\r\n\theader = header2;\r\n\r\n\tcrypt(header + crypt_offset, crypt_size, 0);\r\n\tif(*post_data_len > 0)\r\n\t{\r\n\t\tcrypt(*post_data, *post_data_len, crypt_size % 256);\r\n\t}\r\n\t\r\n\t//msg(\"proxy_rd: debug message\", header);\r\n\r\n\treturn header;\r\n}\r\n"
options="6208"
